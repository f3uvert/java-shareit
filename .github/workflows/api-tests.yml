name: ShareIt API Tests

on:
  pull_request:
    branches: [ main, master ]

jobs:
  api-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Create necessary directories and links
        run: |
          # Создаем директории если их нет
          mkdir -p gateway server
          # Копируем Dockerfile в правильные места
          cp -f ./tests/gateway/Dockerfile ./shareit-gateway/Dockerfile
          cp -f ./tests/server/Dockerfile ./shareit-server/Dockerfile
          # Копируем конфигурационные файлы
          cp -f ./tests/checkstyle.xml ./checkstyle.xml
          cp -f ./tests/suppressions.xml ./suppressions.xml
          cp -f ./tests/docker-compose.yml ./docker-compose.yml

      - name: Build project with Maven
        run: mvn clean compile --no-transfer-progress

      - name: Run Maven tests
        run: mvn test --no-transfer-progress

      - name: Package applications
        run: mvn package -DskipTests --no-transfer-progress

      - name: Build Docker images
        run: |
          # Изменяем docker-compose.yml для использования правильных путей
          sed -i 's/build: gateway/build: shareit-gateway/g' docker-compose.yml
          sed -i 's/build: server/build: shareit-server/g' docker-compose.yml
          # Собираем образы
          docker compose build

      - name: Run Docker containers
        run: |
          # Запускаем контейнеры в фоне
          docker compose up -d
          # Ждем пока сервисы запустятся
          sleep 30
          # Проверяем что сервисы работают
          docker compose ps

      - name: Run API tests (пример)
        run: |
          # Здесь могут быть ваши API тесты
          echo "API tests would run here"
          # Например: curl http://localhost:8080/users

      - name: Stop Docker containers
        if: always()
        run: docker compose down